{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Transformer Networks"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import torch\n",
    "import torch.nn as nn\n",
    "import torch.nn.functional as F\n",
    "import math, copy, time\n",
    "from torch.autograd import Variable\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn\n",
    "seaborn.set_context(context=\"talk\")\n",
    "from IPython.display import SVG\n",
    "from IPython.display import HTML\n",
    "%matplotlib inline"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<style>img{max-height:400px !important;}</style>"
      ],
      "text/plain": [
       "<IPython.core.display.HTML object>"
      ]
     },
     "execution_count": 2,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "style = \"<style>img{max-height:400px !important;}</style>\"\n",
    "HTML(style) # this resizes SVGS in my site files."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Most of the paper was clear. However, it was difficult to see how it would work across sequences of different length. I don't mean how or why the positional encoding would work - this is intuitive, but rather how they construct the matrices to fit together :).\n",
    "\n",
    "This notebook focuses on the unique modules the authors present, and how the system fits together. Other *dependencies* of this post can be viewed at the links below. \n",
    "\n",
    "* [Byte-Encoding](002.ipynb)\n",
    "* Layer Normalization\n",
    "* Residual Connections\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Overview\n",
    "This work focuses on the task of natural language translation (e.g. english to german or vice versa.)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "<div class=\"alert alert-info\">\n",
    "\n",
    "I refer to implementations from the 'tensor2tensor' library and 'The Annotated Transformer' post.\n",
    "\n",
    "</div>"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Encoder Decoder\n",
    "\n",
    "A encoder-decoder [structure](https://arxiv.org/abs/1409.0473) is used: an input sequence of symbols, $x = { x_1, x_2, \\dots, x_n }$, is encoded into a sequence of continuous variables,  $\\mathbf{z} = { z_1, z_2, \\dots, z_n }$. This is then decoded into a sequence of symbols, $y = { y_1, y_2, \\dots, y_n }$. This generation occurs one at a time - it is [auto-regressive](https://arxiv.org/abs/1308.0850), further consuming the previously generated symbols as additional input when generating the next. Encoder and decoder models usually use a recurrent architecture."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "According to Cho. 14, the encoding function $e$ can be any non-linear function, but it is often implemented as an RNN.\n",
    "\n",
    "\\begin{equation} \n",
    "h_{<t>} = e(h_{<t-1>}, x_t)\n",
    "\\end{equation}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "image/svg+xml": [
       "<svg viewBox=\"0 0 372 219\" xmlns=\"http://www.w3.org/2000/svg\"><defs><style>.a{fill:#9db4ff;}.b,.h,.j{fill:#020000;font-size:20px;}.b{font-family:Hack-Regular, Hack;}.c{font-size:10px;}.d,.l{fill:#707070;}.e{fill:none;stroke:#707070;}.f{fill:#ff9d9d;}.g{fill:#fb9dff;}.h{font-family:Menlo-Italic, Menlo;font-style:italic;}.i{fill:#fff09d;}.j{font-family:Hack-Bold, Hack;font-weight:700;}.k,.l{stroke:none;}</style></defs><g transform=\"translate(9 545)\"><rect class=\"a\" height=\"40\" transform=\"translate(40 -416)\" width=\"40\"/><text class=\"b\" transform=\"translate(60 -389)\"><tspan x=\"-9.031\" y=\"0\">X</tspan><tspan class=\"c\" y=\"0\">1</tspan></text><rect class=\"a\" height=\"40\" transform=\"translate(90 -416)\" width=\"40\"/><text class=\"b\" transform=\"translate(111 -389)\"><tspan x=\"-9.031\" y=\"0\">X</tspan><tspan class=\"c\" y=\"0\">2</tspan></text><rect class=\"a\" height=\"40\" transform=\"translate(140 -416)\" width=\"40\"/><text class=\"b\" transform=\"translate(160 -389)\"><tspan x=\"-9.031\" y=\"0\">X</tspan><tspan class=\"c\" y=\"0\">3</tspan></text><rect class=\"a\" height=\"40\" transform=\"translate(190 -416)\" width=\"40\"/><text class=\"b\" transform=\"translate(210 -389)\"><tspan x=\"-9.031\" y=\"0\">X</tspan><tspan class=\"c\" y=\"0\">4</tspan></text><rect class=\"a\" height=\"40\" transform=\"translate(240 -416)\" width=\"40\"/><text class=\"b\" transform=\"translate(260 -389)\"><tspan x=\"-9.031\" y=\"0\">X</tspan><tspan class=\"c\" y=\"0\">5</tspan></text><g class=\"d\" transform=\"translate(59.5 -370) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(59.518 -369.373)\" y2=\"16.479\"/><g class=\"d\" transform=\"translate(110.5 -370) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(110.518 -368.373)\" y2=\"16.479\"/><g class=\"d\" transform=\"translate(159.5 -370) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(159.518 -369.373)\" y2=\"16.479\"/><g class=\"d\" transform=\"translate(209.5 -370) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(209.518 -369.373)\" y2=\"16.479\"/><g class=\"d\" transform=\"translate(259.5 -370) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(259.518 -369.373)\" y2=\"16.479\"/><text class=\"b\" transform=\"translate(62 -331)\"><tspan x=\"-18.062\" y=\"0\">the</tspan></text><text class=\"b\" transform=\"translate(114 -331)\"><tspan x=\"-18.062\" y=\"0\">cat</tspan></text><text class=\"b\" transform=\"translate(160 -331)\"><tspan x=\"-12.041\" y=\"0\">in</tspan></text><text class=\"b\" transform=\"translate(209 -331)\"><tspan x=\"-18.062\" y=\"0\">the</tspan></text><text class=\"b\" transform=\"translate(260 -331)\"><tspan x=\"-18.062\" y=\"0\">hat</tspan></text><g class=\"d\" transform=\"translate(59.5 -439) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(59.518 -438.373)\" y2=\"16.479\"/><g class=\"d\" transform=\"translate(110.5 -439) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(110.518 -437.373)\" y2=\"16.479\"/><g class=\"d\" transform=\"translate(159.5 -439) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(159.518 -438.373)\" y2=\"16.479\"/><g class=\"d\" transform=\"translate(209.5 -439) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(209.518 -438.373)\" y2=\"16.479\"/><g class=\"d\" transform=\"translate(259.5 -439) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(259.518 -438.373)\" y2=\"16.479\"/><rect class=\"f\" height=\"40\" transform=\"translate(-9 -545)\" width=\"40\"/><text class=\"b\" transform=\"translate(11 -518)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"c\" y=\"0\">0</tspan></text><rect class=\"g\" height=\"40\" transform=\"translate(40 -481)\" width=\"40\"/><text class=\"h\" transform=\"translate(60 -454)\"><tspan x=\"-6.021\" y=\"0\">e</tspan></text><g class=\"d\" transform=\"translate(57.5 -503) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(57.518 -502.373)\" y2=\"16.479\"/><rect class=\"f\" height=\"40\" transform=\"translate(38 -545)\" width=\"40\"/><text class=\"b\" transform=\"translate(58 -518)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"c\" y=\"0\">1</tspan></text><g class=\"d\" transform=\"translate(44.537 -484.893) rotate(-135)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(44.518 -485.521) rotate(180)\" y2=\"13.779\"/><line class=\"e\" transform=\"translate(22 -499) rotate(180)\" y2=\"5.45\"/><line class=\"e\" transform=\"translate(22.5 -499.5)\" x2=\"22.5\"/><rect class=\"g\" height=\"40\" transform=\"translate(90 -481)\" width=\"40\"/><text class=\"h\" transform=\"translate(110 -454)\"><tspan x=\"-6.021\" y=\"0\">e</tspan></text><g class=\"d\" transform=\"translate(107.5 -503) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(107.518 -502.373)\" y2=\"16.479\"/><rect class=\"f\" height=\"40\" transform=\"translate(88 -545)\" width=\"40\"/><text class=\"b\" transform=\"translate(108 -518)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"c\" y=\"0\">2</tspan></text><g class=\"d\" transform=\"translate(94.537 -484.893) rotate(-135)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(94.518 -485.521) rotate(180)\" y2=\"13.779\"/><line class=\"e\" transform=\"translate(72 -499) rotate(180)\" y2=\"5.45\"/><line class=\"e\" transform=\"translate(72.5 -499.5)\" x2=\"22.5\"/><rect class=\"g\" height=\"40\" transform=\"translate(140 -481)\" width=\"40\"/><text class=\"h\" transform=\"translate(160 -454)\"><tspan x=\"-6.021\" y=\"0\">e</tspan></text><g class=\"d\" transform=\"translate(157.5 -503) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(157.518 -502.373)\" y2=\"16.479\"/><rect class=\"f\" height=\"40\" transform=\"translate(138 -545)\" width=\"40\"/><text class=\"b\" transform=\"translate(158 -518)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"c\" y=\"0\">3</tspan></text><g class=\"d\" transform=\"translate(144.537 -484.893) rotate(-135)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(144.518 -485.521) rotate(180)\" y2=\"13.779\"/><line class=\"e\" transform=\"translate(122 -499) rotate(180)\" y2=\"5.45\"/><line class=\"e\" transform=\"translate(122.5 -499.5)\" x2=\"22.5\"/><rect class=\"g\" height=\"40\" transform=\"translate(190 -481)\" width=\"40\"/><text class=\"h\" transform=\"translate(210 -454)\"><tspan x=\"-6.021\" y=\"0\">e</tspan></text><g class=\"d\" transform=\"translate(207.5 -503) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(207.518 -502.373)\" y2=\"16.479\"/><rect class=\"f\" height=\"40\" transform=\"translate(188 -545)\" width=\"40\"/><text class=\"b\" transform=\"translate(208 -518)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"c\" y=\"0\">4</tspan></text><g class=\"d\" transform=\"translate(194.537 -484.893) rotate(-135)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(194.518 -485.521) rotate(180)\" y2=\"13.779\"/><line class=\"e\" transform=\"translate(172 -499) rotate(180)\" y2=\"5.45\"/><line class=\"e\" transform=\"translate(172.5 -499.5)\" x2=\"22.5\"/><rect class=\"g\" height=\"40\" transform=\"translate(240 -481)\" width=\"40\"/><text class=\"h\" transform=\"translate(260 -454)\"><tspan x=\"-6.021\" y=\"0\">e</tspan></text><g class=\"d\" transform=\"translate(257.5 -503) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(257.518 -502.373)\" y2=\"16.479\"/><rect class=\"f\" height=\"40\" transform=\"translate(238 -545)\" width=\"40\"/><text class=\"b\" transform=\"translate(258 -518)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"c\" y=\"0\">5</tspan></text><g class=\"d\" transform=\"translate(244.537 -484.893) rotate(-135)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(244.518 -485.521) rotate(180)\" y2=\"13.779\"/><line class=\"e\" transform=\"translate(222 -499) rotate(180)\" y2=\"5.45\"/><line class=\"e\" transform=\"translate(222.5 -499.5)\" x2=\"22.5\"/><g transform=\"translate(-247.928 -926.965) rotate(90)\"><g class=\"d\" transform=\"translate(401.5 -562) rotate(45)\"><path class=\"k\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"l\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"e\" transform=\"translate(401.465 -561.373)\" x1=\"0.053\" y2=\"28.944\"/></g><rect class=\"i\" height=\"40\" transform=\"translate(323 -545)\" width=\"40\"/><text class=\"j\" transform=\"translate(343 -518)\"><tspan x=\"-6.021\" y=\"0\">z</tspan></text></g></svg>"
      ],
      "text/plain": [
       "<IPython.core.display.SVG object>"
      ]
     },
     "execution_count": 18,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "SVG(filename=\"images/[003]/encoder.svg\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The input sentence $x$ is encoded into the vector $\\mathbf{z}$. Depending on the implemention, we consider the final hidden states as the encoding, or some operation on all the hidden states.\n",
    "\n",
    "Next, we decode $\\mathbf{z}$ into the output predictions $y$. Again, this uses a recurrent function (RNN). \n",
    "\n",
    "\n",
    "\\begin{align}\n",
    "h_{<t>} =& d(h_{<t-1>}, y_{<t-1>}, z)\\\\\n",
    "y_{<t>} =& g(h_{<t>}, y_{<t-1>}, z)\\\\\n",
    "\\end{align}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "image/svg+xml": [
       "<svg viewBox=\"0 0 292.018 339\" xmlns=\"http://www.w3.org/2000/svg\"><defs><style>.a,.n{fill:#707070;}.b,.l{fill:none;stroke:#707070;}.c,.g,.k{fill:#020000;font-size:20px;}.c{font-family:Hack-Regular, Hack;}.d{fill:#ff9d9d;}.e{font-size:10px;}.f{fill:#fb9dff;}.g{font-family:Menlo-Italic, Menlo;font-style:italic;}.h{fill:#10ebfd;}.i{fill:#9dffa8;}.j{fill:#fff09d;}.k{font-family:Hack-Bold, Hack;font-weight:700;}.l{stroke-dasharray:2;}.m,.n{stroke:none;}</style></defs><g transform=\"translate(-411 641)\"><g class=\"a\" transform=\"translate(477.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(477.518 -503.373)\" y2=\"16.479\"/><g class=\"a\" transform=\"translate(528.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(528.518 -502.373)\" y2=\"16.479\"/><g class=\"a\" transform=\"translate(577.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(577.518 -503.373)\" y2=\"16.479\"/><g class=\"a\" transform=\"translate(627.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(627.518 -503.373)\" y2=\"16.479\"/><g class=\"a\" transform=\"translate(677.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(677.518 -503.373)\" y2=\"16.479\"/><text class=\"c\" transform=\"translate(479 -622)\"><tspan x=\"-18.062\" y=\"0\">die</tspan></text><text class=\"c\" transform=\"translate(531 -622)\"><tspan x=\"-30.103\" y=\"0\">Katze</tspan></text><text class=\"c\" transform=\"translate(577 -622)\"><tspan x=\"-12.041\" y=\"0\">im</tspan></text><text class=\"c\" transform=\"translate(626 -622)\"><tspan x=\"-18.062\" y=\"0\">das</tspan></text><text class=\"c\" transform=\"translate(677 -622)\"><tspan x=\"-18.062\" y=\"0\">Hut</tspan></text><rect class=\"d\" height=\"40\" transform=\"translate(411 -481)\" width=\"40\"/><text class=\"c\" transform=\"translate(431 -454)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"e\" y=\"0\">0</tspan></text><rect class=\"f\" height=\"40\" transform=\"translate(458 -416)\" width=\"40\"/><text class=\"g\" transform=\"translate(478 -389)\"><tspan x=\"-6.021\" y=\"0\">d</tspan></text><g class=\"a\" transform=\"translate(477.5 -439) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(477.518 -438.373)\" y2=\"16.479\"/><rect class=\"d\" height=\"40\" transform=\"translate(458 -481)\" width=\"40\"/><text class=\"c\" transform=\"translate(478 -454)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"e\" y=\"0\">1</tspan></text><g class=\"a\" transform=\"translate(464.537 -420.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(464.518 -421.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(442 -435) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(442.5 -435.5)\" x2=\"22.5\"/><rect class=\"f\" height=\"40\" transform=\"translate(508 -416)\" width=\"40\"/><text class=\"g\" transform=\"translate(528 -389)\"><tspan x=\"-6.021\" y=\"0\">d</tspan></text><g class=\"a\" transform=\"translate(527.5 -439) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(527.518 -438.373)\" y2=\"16.479\"/><rect class=\"d\" height=\"40\" transform=\"translate(508 -481)\" width=\"40\"/><text class=\"c\" transform=\"translate(528 -454)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"e\" y=\"0\">2</tspan></text><g class=\"a\" transform=\"translate(514.537 -420.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(514.518 -421.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(492 -435) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(492.5 -435.5)\" x2=\"22.5\"/><rect class=\"f\" height=\"40\" transform=\"translate(558 -416)\" width=\"40\"/><text class=\"g\" transform=\"translate(578 -389)\"><tspan x=\"-6.021\" y=\"0\">d</tspan></text><g class=\"a\" transform=\"translate(577.5 -439) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(577.518 -438.373)\" y2=\"16.479\"/><rect class=\"d\" height=\"40\" transform=\"translate(558 -481)\" width=\"40\"/><text class=\"c\" transform=\"translate(578 -454)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"e\" y=\"0\">3</tspan></text><g class=\"a\" transform=\"translate(564.537 -420.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(564.518 -421.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(542 -435) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(542.5 -435.5)\" x2=\"22.5\"/><rect class=\"f\" height=\"40\" transform=\"translate(608 -416)\" width=\"40\"/><text class=\"g\" transform=\"translate(630 -390)\"><tspan x=\"-6.021\" y=\"0\">d</tspan></text><g class=\"a\" transform=\"translate(627.5 -439) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(627.518 -438.373)\" y2=\"16.479\"/><rect class=\"d\" height=\"40\" transform=\"translate(608 -481)\" width=\"40\"/><text class=\"c\" transform=\"translate(628 -454)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"e\" y=\"0\">4</tspan></text><g class=\"a\" transform=\"translate(614.537 -420.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(614.518 -421.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(592 -435) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(592.5 -435.5)\" x2=\"22.5\"/><rect class=\"f\" height=\"40\" transform=\"translate(658 -416)\" width=\"40\"/><text class=\"g\" transform=\"translate(678 -389)\"><tspan x=\"-6.021\" y=\"0\">d</tspan></text><g class=\"a\" transform=\"translate(677.5 -439) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(677.518 -438.373)\" y2=\"16.479\"/><g class=\"a\" transform=\"translate(664.537 -420.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(664.518 -421.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(642 -435) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(642.5 -435.5)\" x2=\"22.5\"/><rect class=\"d\" height=\"40\" transform=\"translate(658 -482)\" width=\"40\"/><text class=\"c\" transform=\"translate(678 -455)\"><tspan x=\"-9.031\" y=\"0\">h</tspan><tspan class=\"e\" y=\"0\">5</tspan></text><rect class=\"h\" height=\"40\" transform=\"translate(458 -548)\" width=\"40\"/><text class=\"g\" transform=\"translate(478 -521)\"><tspan x=\"-6.021\" y=\"0\">g</tspan></text><g class=\"a\" transform=\"translate(477.5 -568) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(477.518 -567.373)\" y2=\"16.479\"/><rect class=\"i\" height=\"40\" transform=\"translate(458 -611)\" width=\"40\"/><text class=\"c\" transform=\"translate(478 -584)\"><tspan x=\"-9.031\" y=\"0\">Y</tspan><tspan class=\"e\" y=\"0\">1</tspan></text><rect class=\"j\" height=\"40\" transform=\"translate(560 -342)\" width=\"40\"/><text class=\"k\" transform=\"translate(580 -315)\"><tspan x=\"-6.021\" y=\"0\">z</tspan></text><g class=\"a\" transform=\"translate(479.5 -374) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(479.518 -372.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(479.518 -372.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(479 -356.5)\" x2=\"223.5\"/><g class=\"a\" transform=\"translate(528.5 -374) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(528.518 -372.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(528.518 -372.373)\" y2=\"16\"/><g class=\"a\" transform=\"translate(579.5 -374) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(579.518 -372.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(579.518 -372.373)\" y2=\"16\"/><g class=\"a\" transform=\"translate(629.5 -374) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(629.518 -372.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(629.518 -372.373)\" y2=\"16\"/><g class=\"a\" transform=\"translate(679.5 -374) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(679.518 -372.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(679.518 -372.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(579.518 -360.373)\" y2=\"16.479\"/><g class=\"a\" transform=\"translate(492.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(492.518 -502.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(492.518 -502.373)\" y2=\"16\"/><line class=\"b\" transform=\"translate(492 -486.5)\" x2=\"10.5\"/><line class=\"l\" transform=\"translate(502.518 -487)\" y2=\"130.5\"/><rect class=\"h\" height=\"40\" transform=\"translate(458 -548)\" width=\"40\"/><text class=\"g\" transform=\"translate(478 -521)\"><tspan x=\"-6.021\" y=\"0\">g</tspan></text><g class=\"a\" transform=\"translate(477.5 -568) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(477.518 -567.373)\" y2=\"16.479\"/><rect class=\"i\" height=\"40\" transform=\"translate(458 -611)\" width=\"40\"/><text class=\"c\" transform=\"translate(478 -584)\"><tspan x=\"-9.031\" y=\"0\">Y</tspan><tspan class=\"e\" y=\"0\">1</tspan></text><g class=\"a\" transform=\"translate(492.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(492.518 -502.373)\" y2=\"16\"/><line class=\"l\" transform=\"translate(502.518 -487)\" y2=\"130.5\"/><line class=\"b\" transform=\"translate(542 -486.5)\" x2=\"10.5\"/><rect class=\"h\" height=\"40\" transform=\"translate(508 -548)\" width=\"40\"/><text class=\"g\" transform=\"translate(528 -521)\"><tspan x=\"-6.021\" y=\"0\">g</tspan></text><g class=\"a\" transform=\"translate(527.5 -568) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(527.518 -567.373)\" y2=\"16.479\"/><rect class=\"i\" height=\"40\" transform=\"translate(508 -611)\" width=\"40\"/><text class=\"c\" transform=\"translate(528 -584)\"><tspan x=\"-9.031\" y=\"0\">Y</tspan><tspan class=\"e\" y=\"0\">1</tspan></text><g class=\"a\" transform=\"translate(542.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(542.518 -502.373)\" y2=\"16\"/><line class=\"l\" transform=\"translate(552.518 -487)\" y2=\"130.5\"/><line class=\"b\" transform=\"translate(592 -486.5)\" x2=\"10.5\"/><rect class=\"h\" height=\"40\" transform=\"translate(558 -548)\" width=\"40\"/><text class=\"g\" transform=\"translate(578 -521)\"><tspan x=\"-6.021\" y=\"0\">g</tspan></text><g class=\"a\" transform=\"translate(577.5 -568) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(577.518 -567.373)\" y2=\"16.479\"/><rect class=\"i\" height=\"40\" transform=\"translate(558 -611)\" width=\"40\"/><text class=\"c\" transform=\"translate(578 -584)\"><tspan x=\"-9.031\" y=\"0\">Y</tspan><tspan class=\"e\" y=\"0\">1</tspan></text><g class=\"a\" transform=\"translate(592.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(592.518 -502.373)\" y2=\"16\"/><line class=\"l\" transform=\"translate(602.518 -487)\" y2=\"130.5\"/><line class=\"b\" transform=\"translate(642 -486.5)\" x2=\"10.5\"/><rect class=\"h\" height=\"40\" transform=\"translate(608 -548)\" width=\"40\"/><text class=\"g\" transform=\"translate(628 -521)\"><tspan x=\"-6.021\" y=\"0\">g</tspan></text><g class=\"a\" transform=\"translate(627.5 -568) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(627.518 -567.373)\" y2=\"16.479\"/><rect class=\"i\" height=\"40\" transform=\"translate(608 -611)\" width=\"40\"/><text class=\"c\" transform=\"translate(628 -584)\"><tspan x=\"-9.031\" y=\"0\">Y</tspan><tspan class=\"e\" y=\"0\">1</tspan></text><g class=\"a\" transform=\"translate(642.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(642.518 -502.373)\" y2=\"16\"/><line class=\"l\" transform=\"translate(652.518 -487)\" y2=\"130.5\"/><line class=\"b\" transform=\"translate(692 -486.5)\" x2=\"10.5\"/><rect class=\"h\" height=\"40\" transform=\"translate(658 -548)\" width=\"40\"/><text class=\"g\" transform=\"translate(678 -521)\"><tspan x=\"-6.021\" y=\"0\">g</tspan></text><g class=\"a\" transform=\"translate(677.5 -568) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(677.518 -567.373)\" y2=\"16.479\"/><rect class=\"i\" height=\"40\" transform=\"translate(658 -611)\" width=\"40\"/><text class=\"c\" transform=\"translate(678 -584)\"><tspan x=\"-9.031\" y=\"0\">Y</tspan><tspan class=\"e\" y=\"0\">1</tspan></text><g class=\"a\" transform=\"translate(692.5 -504) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(692.518 -502.373)\" y2=\"16\"/><line class=\"l\" transform=\"translate(702.518 -487)\" y2=\"130.5\"/><g class=\"a\" transform=\"translate(515.537 -550.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(515.518 -551.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(493 -565) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(493.5 -565.5)\" x2=\"22.5\"/><line class=\"b\" transform=\"translate(506.5 -565.5)\" y2=\"130\"/><g class=\"a\" transform=\"translate(565.537 -550.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(565.518 -551.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(543 -565) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(543.5 -565.5)\" x2=\"22.5\"/><line class=\"b\" transform=\"translate(556.5 -565.5)\" y2=\"130\"/><g class=\"a\" transform=\"translate(614.537 -550.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(614.518 -551.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(592 -565) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(592.5 -565.5)\" x2=\"22.5\"/><line class=\"b\" transform=\"translate(605.5 -565.5)\" y2=\"130\"/><g class=\"a\" transform=\"translate(665.537 -550.893) rotate(-135)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"b\" transform=\"translate(665.518 -551.521) rotate(180)\" y2=\"13.779\"/><line class=\"b\" transform=\"translate(643 -565) rotate(180)\" y2=\"5.45\"/><line class=\"b\" transform=\"translate(643.5 -565.5)\" x2=\"22.5\"/><line class=\"b\" transform=\"translate(656.5 -565.5)\" y2=\"130\"/></g></svg>"
      ],
      "text/plain": [
       "<IPython.core.display.SVG object>"
      ]
     },
     "execution_count": 19,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "SVG(filename=\"images/003/decoder.svg\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "This structure has some issues.\n",
    "\n",
    "1. Its sequential and for a given $x$, it cannot be parallelized.\n",
    "2. Often $\\mathbf{z}$ is input into each decoding function, and since $\\mathbf{z}$ is O(n) distance to each input symbol, it becomes difficult to learn long range dependencies.\n",
    "3. The path between an output symbol and its corresponding source symbol depends on the length of $x$.\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The transformer network uses a stateless auto-regressive strategy which will decode the encoded (but not summarized) source words and the current output words. This will allow the model to be highly parallelized.\n",
    "\n",
    "The primary featured used is scaled dot product attention."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Scaled Dot-Product Attention\n",
    "\n",
    "The authors describe attention as follows:\n",
    "\n",
    "> An attention function can be described as mapping a query and a set of key-value pairs to an output, where the query, keys, values, and output are all vectors.  The output is computed as a weighted sum of the values, where the weight assigned to each value is computed by a compatibility function of the query with the corresponding key.\n",
    "\n",
    "In addition to attention, they use a few techniques to regularize their network: layer normalization, residual connections, and dropout."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "As noted by the authors, attention maps a query to a combination of given outputs, as determined by the query's corresponding compatibility with the input keys. As the autological \"Scaled Dot-Product Attention\" method implies, the authors use dot product for their compatibility function. One could use any metric, learned or otherwise. Cosine distance or a layer of MLP can be used."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "image/svg+xml": [
       "<svg viewBox=\"0 0 609 483.107\" xmlns=\"http://www.w3.org/2000/svg\"><defs><style>.a,.k,.q,.x{fill:#95abf4;}.b,.d{fill:#020000;}.b{font-size:20px;}.b,.e,.s{font-family:Menlo-Regular, Menlo;}.c,.m,.o,.y{fill:#9dffa8;}.d,.e,.s{font-size:15px;}.d{font-family:Menlo-Italic, Menlo;font-style:italic;}.f,.g{fill:#fff;}.f,.j{stroke:#707070;}.g{stroke:#fff;}.h,.p,.s{fill:#fb9dff;}.i,.w{fill:#707070;}.j,.l,.n,.v{fill:none;}.l{stroke:#95abf4;}.n{stroke:#9dffa8;}.o,.p,.q{font-family:Menlo-Bold, Menlo;font-weight:700;}.r{fill:#10ebfd;}.t{fill:#000;}.u,.w,.x,.y{stroke:none;}</style></defs><g transform=\"translate(15 -11.893)\"><path class=\"a\" d=\"M0,0H40V40H0Z\" transform=\"translate(-11 14)\"/><text class=\"b\" transform=\"translate(9 41)\"><tspan x=\"-6.021\" y=\"0\">Q</tspan></text><rect class=\"c\" height=\"40\" transform=\"translate(-12 82)\" width=\"40\"/><text class=\"b\" transform=\"translate(8 109)\"><tspan x=\"-6.021\" y=\"0\">K</tspan></text><text class=\"d\" transform=\"translate(9 69)\"><tspan x=\"-22.577\" y=\"0\">q . d</tspan></text><text class=\"d\" transform=\"translate(8 137)\"><tspan x=\"-22.577\" y=\"0\">n . d</tspan></text><text class=\"e\" transform=\"translate(329 114)\"><tspan x=\"0\" y=\"0\">k2</tspan></text><text class=\"e\" transform=\"translate(499 114)\"><tspan x=\"0\" y=\"0\">q1</tspan></text><text class=\"e\" transform=\"translate(49 39)\"><tspan x=\"0\" y=\"0\">=</tspan></text><text class=\"e\" transform=\"translate(48 107)\"><tspan x=\"0\" y=\"0\">=</tspan></text><g class=\"f\" transform=\"translate(75 14)\"><rect class=\"u\" height=\"40\" width=\"49\"/><rect class=\"v\" height=\"39\" width=\"48\" x=\"0.5\" y=\"0.5\"/></g><g class=\"g\" transform=\"translate(81 14)\"><rect class=\"u\" height=\"40\" width=\"36\"/><rect class=\"v\" height=\"39\" width=\"35\" x=\"0.5\" y=\"0.5\"/></g><text class=\"e\" transform=\"translate(90 30)\"><tspan x=\"0\" y=\"0\">q1</tspan></text><text class=\"e\" transform=\"translate(90 50)\"><tspan x=\"0\" y=\"0\">q2</tspan></text><path class=\"h\" d=\"M0,0H40V40H0Z\" transform=\"translate(-13 153)\"/><text class=\"b\" transform=\"translate(7 180)\"><tspan x=\"-6.021\" y=\"0\">V</tspan></text><text class=\"d\" transform=\"translate(8 208)\"><tspan x=\"-22.577\" y=\"0\">n . v</tspan></text><text class=\"e\" transform=\"translate(48 175)\"><tspan x=\"0\" y=\"0\">=</tspan></text><g class=\"f\" transform=\"translate(74 142)\"><rect class=\"u\" height=\"55\" width=\"49\"/><rect class=\"v\" height=\"54\" width=\"48\" x=\"0.5\" y=\"0.5\"/></g><g class=\"g\" transform=\"translate(80 142)\"><rect class=\"u\" height=\"55\" width=\"36\"/><rect class=\"v\" height=\"54\" width=\"35\" x=\"0.5\" y=\"0.5\"/></g><text class=\"e\" transform=\"translate(89 155)\"><tspan x=\"0\" y=\"0\">v1</tspan></text><text class=\"e\" transform=\"translate(89 175)\"><tspan x=\"0\" y=\"0\">v2</tspan></text><text class=\"e\" transform=\"translate(89 193)\"><tspan x=\"0\" y=\"0\">v3</tspan></text><g class=\"f\" transform=\"translate(74 75)\"><rect class=\"u\" height=\"55\" width=\"49\"/><rect class=\"v\" height=\"54\" width=\"48\" x=\"0.5\" y=\"0.5\"/></g><g class=\"g\" transform=\"translate(80 75)\"><rect class=\"u\" height=\"55\" width=\"36\"/><rect class=\"v\" height=\"54\" width=\"35\" x=\"0.5\" y=\"0.5\"/></g><text class=\"e\" transform=\"translate(89 88)\"><tspan x=\"0\" y=\"0\">k1</tspan></text><text class=\"e\" transform=\"translate(89 108)\"><tspan x=\"0\" y=\"0\">k2</tspan></text><text class=\"e\" transform=\"translate(89 126)\"><tspan x=\"0\" y=\"0\">k3</tspan></text><g class=\"i\" transform=\"translate(417.5 11.893) rotate(45)\"><path class=\"u\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"w\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(339.449 12.521)\"><line class=\"j\" transform=\"translate(78.051)\" y2=\"161.409\"/></g><g class=\"i\" transform=\"translate(579.537 173.893) rotate(135)\"><path class=\"u\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"w\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(578.909 95.842) rotate(90)\"><line class=\"j\" transform=\"translate(78.051)\" y2=\"161.409\"/></g><g class=\"i\" transform=\"translate(325.467 251.003) rotate(-85)\"><path class=\"u\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"w\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"matrix(-0.643, -0.766, 0.766, -0.643, 376.117, 310.39)\"><line class=\"j\" transform=\"translate(78.051)\" y2=\"120.427\"/></g><g class=\"k\" transform=\"translate(561.698 100.114) rotate(108)\"><path class=\"u\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"x\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"matrix(0.454, 0.891, -0.891, 0.454, 525.704, 30.855)\"><line class=\"l\" transform=\"translate(78.051)\" y2=\"161.409\"/></g><g class=\"k\" transform=\"translate(362.826 323.05) rotate(-115)\"><path class=\"u\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"x\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"matrix(-0.94, -0.342, 0.342, -0.94, 436.384, 349.156)\"><line class=\"l\" transform=\"translate(78.051)\" y2=\"161.409\"/></g><g class=\"k\" transform=\"translate(273.099 241.168) rotate(-70)\"><path class=\"u\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"x\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(306.653 311.641) rotate(-115)\"><line class=\"l\" transform=\"translate(78.051)\" y2=\"161.409\"/></g><g class=\"m\" transform=\"translate(552.17 125.094) rotate(115)\"><path class=\"u\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"y\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(524.724 51.52) rotate(70)\"><line class=\"n\" transform=\"translate(78.525)\" y2=\"141.937\"/></g><g class=\"m\" transform=\"translate(327.36 65.898) rotate(5)\"><path class=\"u\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"y\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(267.61 116.853) rotate(-40)\"><line class=\"n\" transform=\"translate(78.525)\" y2=\"141.937\"/></g><text class=\"e\" transform=\"translate(525 151)\"><tspan x=\"0\" y=\"0\">k1</tspan></text><text class=\"e\" transform=\"translate(288 217)\"><tspan x=\"0\" y=\"0\">q2</tspan></text><text class=\"e\" transform=\"translate(382 299)\"><tspan x=\"0\" y=\"0\">q3</tspan></text><text class=\"e\" transform=\"translate(-15 365)\"><tspan x=\"0\" y=\"0\">1. Each key </tspan><tspan class=\"o\" y=\"0\">K</tspan><tspan y=\"0\">_i maps to a value </tspan><tspan class=\"p\" y=\"0\">V</tspan><tspan y=\"0\">_i.</tspan><tspan x=\"0\" y=\"18\">2. Each query </tspan><tspan class=\"q\" y=\"18\">Q</tspan><tspan y=\"18\">_j will operate on all the keys</tspan><tspan x=\"0\" xml:space=\"preserve\" y=\"36\">   with a compatibility function (dot product).</tspan><tspan x=\"0\" y=\"54\">3. These scores will be transformed into a </tspan><tspan x=\"0\" xml:space=\"preserve\" y=\"72\">   probability distribution by a </tspan><tspan class=\"r\" y=\"72\">softmax</tspan><tspan y=\"72\">.</tspan><tspan x=\"0\" y=\"90\">3. Then, each query will be mapped to a linear </tspan><tspan x=\"0\" xml:space=\"preserve\" y=\"108\">   combination of the values as determined by</tspan><tspan x=\"0\" xml:space=\"preserve\" y=\"126\">   the probability distribution, e.g:</tspan></text><g class=\"f\" transform=\"translate(440 385)\"><rect class=\"u\" height=\"76\" width=\"154\"/><rect class=\"v\" height=\"75\" width=\"153\" x=\"0.5\" y=\"0.5\"/></g><g class=\"g\" transform=\"translate(448 385)\"><rect class=\"u\" height=\"76\" width=\"139\"/><rect class=\"v\" height=\"75\" width=\"138\" x=\"0.5\" y=\"0.5\"/></g><text class=\"s\" transform=\"translate(448 410)\"><tspan class=\"r\" x=\"0\" y=\"0\">0.8</tspan><tspan class=\"t\" y=\"0\"> </tspan><tspan class=\"h\" y=\"0\">v1</tspan><tspan class=\"t\" xml:space=\"preserve\" y=\"0\"> + </tspan><tspan class=\"r\" y=\"0\">0.1</tspan><tspan class=\"t\" y=\"0\"> </tspan><tspan class=\"h\" y=\"0\">v2</tspan><tspan class=\"r\" x=\"0\" y=\"18\">0.3</tspan><tspan class=\"t\" y=\"18\"> </tspan><tspan class=\"h\" y=\"18\">v1</tspan><tspan class=\"t\" xml:space=\"preserve\" y=\"18\"> + </tspan><tspan class=\"r\" y=\"18\">0.7</tspan><tspan class=\"t\" y=\"18\"> </tspan><tspan class=\"h\" y=\"18\">v2</tspan><tspan class=\"r\" x=\"0\" y=\"36\">0.4</tspan><tspan class=\"t\" y=\"36\"> </tspan><tspan class=\"h\" y=\"36\">v2</tspan><tspan class=\"t\" xml:space=\"preserve\" y=\"36\"> + </tspan><tspan class=\"r\" y=\"36\">0.6</tspan><tspan class=\"t\" y=\"36\"> </tspan><tspan class=\"h\" y=\"36\">v2</tspan></text></g></svg>"
      ],
      "text/plain": [
       "<IPython.core.display.SVG object>"
      ]
     },
     "execution_count": 20,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "SVG(filename=\"images/003/attention-example.svg\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "As shown in the intuitive example above, the query $q_1$ is most similar to $k_1$, thus it is mapped predimately to the corresponding value $v_1$. Note: these values are examples, not necessarily accurate."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The scaled dot product attention is straight forward.\n",
    "\n",
    "\\begin{equation}\n",
    "A: Q \\times K \\times V \\to O \\\\\n",
    "Q\\in \\mathbb{R}^{q \\times d}, K \\in \\mathbb{R}^{n \\times d}, V \\in \\mathbb{R}^{n \\times v}, O \\in \\mathbb{R}^{q \\times v} \\\\\n",
    "A = \\text{SOFTMAX}(\\frac{QK^{\\intercal}}{\\sqrt{d}}) V\n",
    "\\end{equation}\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The innovative aspect of scaled dot product - beyond the authors' apt framing of the problem as an interaction between queries, keys, and values - is the scaling. The author motivate this scaling by noting that the variance of a dot product scales with the size of the input vectors. Increased variance will result in increased magnitude, \"pushing the softmax function into regions where it has extremely small gradients.\"\n",
    "\n",
    "<div class=\"alert alert-info\">\n",
    "\n",
    "Why is the gradient small?\n",
    "\n",
    "</div>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "image/svg+xml": [
       "<svg viewBox=\"0 0 265 519\" xmlns=\"http://www.w3.org/2000/svg\"><defs><style>.a{fill:#fb9dff;}.b,.g,.j,.k{fill:#020000;}.b,.g{font-size:20px;}.b{font-family:Hack-Regular, Hack;}.c{fill:#ff9d9d;}.d{font-size:14px;}.e{fill:#10ebfd;}.f{fill:#9db4ff;}.g{font-family:Menlo-Regular, Menlo;}.h,.n{fill:#707070;}.i{fill:none;stroke:#707070;}.j,.k{font-size:15px;font-style:italic;}.j{font-family:Menlo-Italic, Menlo;}.k{font-family:Hack-Italic, Hack;}.l{fill:#9dffa8;}.m,.n{stroke:none;}</style></defs><g transform=\"translate(387 767)\"><rect class=\"a\" height=\"52\" transform=\"translate(-244 -767)\" width=\"122\"/><text class=\"b\" transform=\"translate(-183 -733)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text><rect class=\"a\" height=\"52\" transform=\"translate(-331 -399)\" width=\"122\"/><text class=\"b\" transform=\"translate(-270 -365)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text><rect class=\"c\" height=\"52\" transform=\"translate(-331 -583)\" width=\"122\"/><text class=\"b\" transform=\"translate(-270 -549)\"><tspan x=\"-53.583\" y=\"0\">Mask</tspan><tspan class=\"d\" xml:space=\"preserve\" y=\"0\"> (opt.)</tspan></text><rect class=\"e\" height=\"52\" transform=\"translate(-331 -675)\" width=\"122\"/><text class=\"b\" transform=\"translate(-270 -641)\"><tspan x=\"-42.144\" y=\"0\">SoftMax</tspan></text><rect class=\"f\" height=\"40\" transform=\"translate(-331 -307)\" width=\"40\"/><text class=\"g\" transform=\"translate(-311 -280)\"><tspan x=\"-6.021\" y=\"0\">Q</tspan></text><rect class=\"f\" height=\"40\" transform=\"translate(-249 -307)\" width=\"40\"/><text class=\"g\" transform=\"translate(-229 -280)\"><tspan x=\"-6.021\" y=\"0\">K</tspan></text><rect class=\"f\" height=\"40\" transform=\"translate(-168 -307)\" width=\"40\"/><text class=\"g\" transform=\"translate(-148 -280)\"><tspan x=\"-6.021\" y=\"0\">V</tspan></text><g class=\"h\" transform=\"translate(-312.5 -342.107) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(-312.5 -341.479)\"><line class=\"i\" y2=\"30\"/></g><g class=\"h\" transform=\"translate(-148.5 -710.107) rotate(45)\"><path class=\"m\" d=\"M 4.539204120635986 10.36787128448486 L 0.8700531721115112 0.8652133941650391 L 10.41672897338867 4.490346431732178 L 7.453537940979004 7.453537940979004 L 4.539204120635986 10.36787128448486 Z\"/><path class=\"n\" d=\"M 1.740111351013184 1.730436325073242 L 4.728905200958252 9.471050262451172 L 7.099977493286133 7.099977970123291 L 9.516582489013672 4.683373928070068 L 1.740111351013184 1.730436325073242 M -1.9073486328125e-06 -1.9073486328125e-06 L 11.31685733795166 4.297317981719971 L 7.807087898254395 7.807087898254395 L 4.34949779510498 11.26467800140381 L -1.9073486328125e-06 -1.9073486328125e-06 Z\"/></g><g transform=\"translate(-148.482 -709.475)\"><line class=\"i\" y2=\"397.996\"/></g><text class=\"j\" transform=\"translate(-311 -252)\"><tspan x=\"-22.577\" y=\"0\">q . d</tspan></text><text class=\"j\" transform=\"translate(-229 -252)\"><tspan x=\"-22.577\" y=\"0\">n . d</tspan></text><text class=\"j\" transform=\"translate(-147 -252)\"><tspan x=\"-22.577\" y=\"0\">n . v</tspan></text><text class=\"j\" transform=\"translate(-364 -368)\"><tspan x=\"-22.577\" y=\"0\">q . n</tspan></text><text class=\"j\" transform=\"translate(-364 -460)\"><tspan x=\"-22.577\" y=\"0\">q . n</tspan></text><text class=\"j\" transform=\"translate(-364 -552)\"><tspan x=\"-22.577\" y=\"0\">q . n</tspan></text><text class=\"j\" transform=\"translate(-362 -644)\"><tspan x=\"-22.577\" y=\"0\">q . n</tspan></text><text class=\"k\" transform=\"translate(-275 -736)\"><tspan x=\"-22.577\" y=\"0\">q . v</tspan></text><rect class=\"l\" height=\"52\" transform=\"translate(-331 -491)\" width=\"122\"/><text class=\"g\" transform=\"translate(-270 -457)\"><tspan x=\"-30.103\" y=\"0\">Scale</tspan></text><text class=\"b\" transform=\"translate(-270 -457)\"><tspan x=\"-30.103\" y=\"0\">Scale</tspan></text><g class=\"h\" transform=\"translate(-227.5 -342.107) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(-227.5 -341.479)\"><line class=\"i\" y2=\"30\"/></g><g class=\"h\" transform=\"translate(-275.5 -434.107) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(-275.5 -433.479)\"><line class=\"i\" y2=\"30\"/></g><g class=\"h\" transform=\"translate(-275.5 -526.107) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(-275.5 -525.479)\"><line class=\"i\" y2=\"30\"/></g><g class=\"h\" transform=\"translate(-275.5 -618.107) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(-275.5 -617.479)\"><line class=\"i\" y2=\"30\"/></g><g class=\"h\" transform=\"translate(-219.5 -710.107) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"n\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(-219.5 -709.479)\"><line class=\"i\" y2=\"30\"/></g></g></svg>"
      ],
      "text/plain": [
       "<IPython.core.display.SVG object>"
      ]
     },
     "execution_count": 21,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "SVG(filename=\"images/003/scaled-dot-product.svg\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Below is an implementation for the scaled dot product. Each line corresponds to a box in the figure above."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [],
   "source": [
    "def attention(query, key, value, mask=None):\n",
    "    \"Compute 'Scaled Dot Product Attention'\"\n",
    "    # Compatiblity function (dot product) between the query and keys.\n",
    "    scores = torch.matmul(query, key.transpose(-2, -1))\n",
    "    # Scale the scores depending on the size of the inputs.\n",
    "    scores = scores / math.sqrt(query.size(-1))\n",
    "    # Optional mask. This is used to zero out values that should not be used by this function.\n",
    "    if mask is not None:    \n",
    "        scores = scores.masked_fill(mask == 0, -1e9)\n",
    "    # Compute probability distribution across the final dimension.\n",
    "    p_attn = F.softmax(scores, dim = -1)\n",
    "    # Output linear combinations of values, as determined by the distribution.\n",
    "    return torch.matmul(p_attn, value), p_attn"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Self Attention\n",
    "With a single query, self attention will have no effect. This is because the attention mechanism will be a linear combination of the values, and it can only reproduce itself so it serves as an identity function."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [],
   "source": [
    "def SelfAttention(X):\n",
    "    Q, K, V = X, X, X\n",
    "    return attention(Q, K, V)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tensor([[0.1000, 0.1000, 0.8000]])\n",
      "tensor([[1.]])\n"
     ]
    }
   ],
   "source": [
    "out, alpha = SelfAttention(torch.FloatTensor([[0.1,0.1,0.8]]))\n",
    "print(out)\n",
    "print(alpha)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "When there are multiple queries, the vectors that are most *compatible* will become even more similar as they will be mapped to combinations consisting mostly of the already compatible vectors. \n",
    "\n",
    "The remaining vector will also be normalized *different*."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tensor([[0.2992, 0.5329, 0.1679],\n",
      "        [0.2228, 0.7070, 0.0702],\n",
      "        [0.2645, 0.2645, 0.4711]])\n"
     ]
    }
   ],
   "source": [
    "X = torch.FloatTensor([\n",
    "    [0,0,1],\n",
    "    [0,0,2],\n",
    "    [1,0,0]\n",
    "])\n",
    "out, alpha = SelfAttention(X)\n",
    "print(alpha)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Note that, especially with values greater than 1, a vector can have a greater dot product with other vectors rather than itself. So, similarity is aptly not the correct word to describe this interaction (at least when using a dot product). Thus, the first vector is mapped to a construction consisting mostly of itself and the second vector follows the same trend but more extreme. Lastly, the third vector, less compatible than the others - becomes pseduo-normalized."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "tensor([[0.1679, 0.0000, 1.3650],\n",
      "        [0.0702, 0.0000, 1.6368],\n",
      "        [0.4711, 0.0000, 0.7934]])\n"
     ]
    }
   ],
   "source": [
    "print(out)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Multi Head Attention\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "The primary representative power of the transformer is \"Multi-Head Attention\". It is built up using the scaled dot product attention.\n",
    "\n",
    "Rather than attend raw queries a single time, this method attends *h* linear projections of the input. For each of the *h* heads, the inputs (K,Q,V) are projected linearily with a learned mapping. This is great! Rather than using a single dot product, the multi-headed attention can learn to project vectors and attend them differently. \n",
    "\n",
    "<div class=\"alert alert-info\">\n",
    "Ultimately, the compatiblity function and the projections are all linear - perhaps it would be worth the time to see if non-linear mappings would drastically effect the performance of this method. Does using a feed forward layer here help? hurt?\n",
    "</div>\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "\\begin{equation}\n",
    "\\text{out} = \\texttt{Concat}(\\text{head}_0, \\dots, \\text{head}_h) W^O \\\\\n",
    "\\text{head}_i = \\texttt{Attention}(QW_i^Q, KW_i^K, VW_i^V) \\\\\n",
    "Q \\in \\mathbb{R}^{q \\times m}, K \\in \\mathbb{R}^{n \\times m}, V \\in \\mathbb{R}^{n \\times m} \\\\\n",
    "W_j^Q, W_j^K, W_j^V \\in \\mathbb{R}^{m \\times d} \\\\\n",
    "W^O \\in \\mathbb{R}^{(h*v)\\times m}\n",
    "\\end{equation}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [],
   "source": [
    "class MultiHeadedAttention(nn.Module):\n",
    "    def __init__(self, h, d_model, dropout=0.1):\n",
    "        \"Take in model size and number of heads.\"\n",
    "        super(MultiHeadedAttention, self).__init__()\n",
    "        assert d_model % h == 0\n",
    "        # We assume d_v always equals d_k\n",
    "        self.d_k = d_model // h\n",
    "        self.h = h\n",
    "        self.linears = clones(nn.Linear(d_model, d_model), 4)\n",
    "        self.attn = None\n",
    "        self.dropout = nn.Dropout(p=dropout)\n",
    "        \n",
    "    def forward(self, query, key, value, mask=None):\n",
    "        \"Implements Figure 2\"\n",
    "        if mask is not None:\n",
    "            # Same mask applied to all h heads.\n",
    "            mask = mask.unsqueeze(1)\n",
    "        nbatches = query.size(0)\n",
    "        \n",
    "        # 1) Do all the linear projections in batch from d_model => h x d_k \n",
    "        query, key, value = \\\n",
    "            [l(x).view(nbatches, -1, self.h, self.d_k).transpose(1, 2)\n",
    "             for l, x in zip(self.linears, (query, key, value))]\n",
    "        \n",
    "        # 2) Apply attention on all the projected vectors in batch. \n",
    "        x, self.attn = attention(query, key, value, mask=mask, \n",
    "                                 dropout=self.dropout)\n",
    "        \n",
    "        # 3) \"Concat\" using a view and apply a final linear. \n",
    "        x = x.transpose(1, 2).contiguous() \\\n",
    "             .view(nbatches, -1, self.h * self.d_k)\n",
    "        return self.linears[-1](x)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Thus, the multi-headed attention is a function from $R^{q*d}$ to $R^{q*v}$. Furthermore, like the scaled-dot-product attention, it is able to concurrently operate on all the queries in parallel regardless of the size of the sentence.\n",
    "\n",
    "Additionally, this module is able to support *h* different heads, and still output a fixed-size vector for each query by concat and then matrix multiply to reduce the dimensionality."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "image/svg+xml": [
       "<svg viewBox=\"0 0 915 290\" xmlns=\"http://www.w3.org/2000/svg\"><defs><style>.a,.q{fill:#9dffa8;}.a,.b,.d,.e,.h,.j,.k{opacity:0.502;}.b,.d,.g,.n,.o,.p,.x{fill:#020000;}.b,.d,.g,.n{font-size:20px;}.b,.n,.x{font-family:Hack-Regular, Hack;}.c{font-size:10px;}.d,.g{font-family:Menlo-Regular, Menlo;}.f{fill:#fb9dff;}.h,.l,.z{fill:#707070;}.aa,.i,.k,.v{fill:none;}.i,.k,.s,.v{stroke:#707070;}.j,.r{fill:#10ebfd;}.m{fill:#9db4ff;}.o,.p,.x{font-size:15px;}.o{font-family:Hack-Italic, Hack;}.o,.p{font-style:italic;}.p{font-family:Menlo-Italic, Menlo;}.s,.t{fill:#fff;}.t{stroke:#fff;}.u{fill:#95abf4;}.v,.w{opacity:0.237;}.x{opacity:0.497;}.y,.z{stroke:none;}</style></defs><g transform=\"translate(-40 -467)\"><rect class=\"a\" height=\"40\" transform=\"translate(230 467)\" width=\"40\"/><text class=\"b\" transform=\"translate(250 494)\"><tspan x=\"-12.041\" y=\"0\">W</tspan><tspan class=\"c\" y=\"0\">q1</tspan></text><rect class=\"a\" height=\"40\" transform=\"translate(230 533)\" width=\"40\"/><text class=\"d\" transform=\"translate(250 561)\"><tspan x=\"-12.041\" y=\"0\">W</tspan><tspan class=\"c\" y=\"0\">k1</tspan></text><rect class=\"a\" height=\"40\" transform=\"translate(230 602)\" width=\"40\"/><text class=\"b\" transform=\"translate(250 629)\"><tspan x=\"-12.041\" y=\"0\">W</tspan><tspan class=\"c\" y=\"0\">v1</tspan></text><g class=\"e\" transform=\"translate(624 883)\"><rect class=\"f\" height=\"52\" transform=\"translate(-331 -399)\" width=\"86\"/><text class=\"g\" transform=\"translate(-287 -366)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text></g><g class=\"e\" transform=\"translate(624 951)\"><rect class=\"f\" height=\"52\" transform=\"translate(-331 -399)\" width=\"86\"/><text class=\"g\" transform=\"translate(-287 -366)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text></g><g class=\"e\" transform=\"translate(624 1019)\"><rect class=\"f\" height=\"52\" transform=\"translate(-331 -399)\" width=\"86\"/><text class=\"g\" transform=\"translate(-287 -366)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text></g><g class=\"h\" transform=\"translate(291.232 491.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g class=\"e\" transform=\"translate(290.605 491.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"19\"/></g><g class=\"h\" transform=\"translate(291.232 561.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g class=\"e\" transform=\"translate(290.605 561.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"19\"/></g><g class=\"h\" transform=\"translate(291.232 632.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g class=\"e\" transform=\"translate(290.605 632.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"19\"/></g><rect class=\"j\" height=\"52\" transform=\"translate(409 553)\" width=\"90\"/><text class=\"d\" transform=\"translate(454 586)\"><tspan x=\"-36.123\" y=\"0\">Attend</tspan></text><line class=\"k\" transform=\"translate(379.5 506.5)\" x2=\"15\"/><g class=\"e\" transform=\"translate(170.893 261.393) rotate(90)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.79009485244751 10.35495471954346 L 0.9132568836212158 0.9083845615386963 L 10.40186786651611 4.743190288543701 L 7.572525501251221 7.572524547576904 L 4.79009485244751 10.35495471954346 Z\"/><path class=\"z\" d=\"M 1.826522827148438 1.816766738891602 L 4.967541694641113 9.470388412475586 L 7.218965530395508 7.218964099884033 L 9.514205932617188 4.923730373382568 L 1.826522827148438 1.816766738891602 M -4.76837158203125e-06 4.76837158203125e-06 L 11.28951549530029 4.562644481658936 L 7.926075458526611 7.926074028015137 L 4.612645149230957 11.23950386047363 L -4.76837158203125e-06 4.76837158203125e-06 Z\"/></g><g transform=\"translate(317.185 -238.466)\"><line class=\"i\" y2=\"15\"/></g></g><line class=\"k\" transform=\"translate(379.5 578.5)\" x2=\"15\"/><line class=\"k\" transform=\"translate(379.5 649.5)\" x2=\"15\"/><line class=\"k\" transform=\"translate(394.5 506.5)\" y2=\"143\"/><rect class=\"m\" height=\"40\" transform=\"translate(165 529)\" width=\"40\"/><text class=\"n\" transform=\"translate(184 556)\"><tspan x=\"-6.021\" y=\"0\">Q</tspan></text><rect class=\"m\" height=\"40\" transform=\"translate(165 597)\" width=\"40\"/><text class=\"g\" transform=\"translate(184 624)\"><tspan x=\"-6.021\" y=\"0\">K</tspan></text><text class=\"o\" transform=\"translate(185 584)\"><tspan x=\"-13.546\" y=\"0\">q.d</tspan></text><text class=\"p\" transform=\"translate(184 652)\"><tspan x=\"-13.546\" y=\"0\">n.d</tspan></text><rect class=\"m\" height=\"40\" transform=\"translate(165 668)\" width=\"40\"/><text class=\"n\" transform=\"translate(184 695)\"><tspan x=\"-6.021\" y=\"0\">V</tspan></text><text class=\"p\" transform=\"translate(184 723)\"><tspan x=\"-13.546\" y=\"0\">n.v</tspan></text><rect class=\"m\" height=\"40\" transform=\"translate(40 597)\" width=\"40\"/><text class=\"n\" transform=\"translate(60 624)\"><tspan x=\"-6.021\" y=\"0\">U</tspan></text><text class=\"o\" transform=\"translate(60 652)\"><tspan x=\"-13.546\" y=\"0\">n.d</tspan></text><text class=\"p\" transform=\"translate(97 753)\"><tspan x=\"-54.185\" y=\"0\">n = q, d = v</tspan></text><rect class=\"q\" height=\"40\" transform=\"translate(212 503)\" width=\"40\"/><text class=\"n\" transform=\"translate(232 530)\"><tspan x=\"-12.041\" y=\"0\">W</tspan><tspan class=\"c\" y=\"0\">qh</tspan></text><rect class=\"q\" height=\"40\" transform=\"translate(212 569)\" width=\"40\"/><text class=\"g\" transform=\"translate(232 597)\"><tspan x=\"-12.041\" y=\"0\">W</tspan><tspan class=\"c\" y=\"0\">kh</tspan></text><rect class=\"q\" height=\"40\" transform=\"translate(212 638)\" width=\"40\"/><text class=\"n\" transform=\"translate(232 665)\"><tspan x=\"-12.041\" y=\"0\">W</tspan><tspan class=\"c\" y=\"0\">vh</tspan></text><line class=\"i\" transform=\"translate(86.5 618.5)\" x2=\"42\"/><g transform=\"translate(-79.875 230.393) rotate(90)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(317.185 -238.479)\"><line class=\"i\" y2=\"30\"/></g></g><line class=\"i\" transform=\"translate(128.5 547.5)\" y2=\"142\"/><g transform=\"translate(-79.875 372.393) rotate(90)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(317.185 -238.479)\"><line class=\"i\" transform=\"translate(0)\" y2=\"30\"/></g></g><g transform=\"translate(-79.875 301.393) rotate(90)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(317.185 -238.479)\"><line class=\"i\" y2=\"30\"/></g></g><g transform=\"translate(-79.875 230.393) rotate(90)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g></g><g transform=\"translate(606 919)\"><rect class=\"f\" height=\"52\" transform=\"translate(-331 -399)\" width=\"86\"/><text class=\"g\" transform=\"translate(-287 -366)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text></g><g transform=\"translate(606 987)\"><rect class=\"f\" height=\"52\" transform=\"translate(-331 -399)\" width=\"86\"/><text class=\"g\" transform=\"translate(-287 -366)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text></g><g transform=\"translate(606 1055)\"><rect class=\"f\" height=\"52\" transform=\"translate(-331 -399)\" width=\"86\"/><text class=\"g\" transform=\"translate(-287 -366)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text></g><g class=\"l\" transform=\"translate(273.232 527.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(272.605 527.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"19\"/></g><g class=\"l\" transform=\"translate(273.232 597.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(272.605 597.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"19\"/></g><g class=\"l\" transform=\"translate(273.232 668.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(272.605 668.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"19\"/></g><g class=\"l\" transform=\"translate(273.232 558.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(272.605 558.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"65\"/></g><g class=\"l\" transform=\"translate(273.232 628.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(272.605 628.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"65\"/></g><g class=\"l\" transform=\"translate(273.232 699.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(272.605 699.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"65\"/></g><rect class=\"r\" height=\"52\" transform=\"translate(391 589)\" width=\"90\"/><text class=\"g\" transform=\"translate(436 622)\"><tspan x=\"-36.123\" y=\"0\">Attend</tspan></text><line class=\"i\" transform=\"translate(361.5 542.5)\" x2=\"15\"/><g transform=\"translate(152.893 297.393) rotate(90)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.79009485244751 10.35495471954346 L 0.9132568836212158 0.9083845615386963 L 10.40186786651611 4.743190288543701 L 7.572525501251221 7.572524547576904 L 4.79009485244751 10.35495471954346 Z\"/><path class=\"z\" d=\"M 1.826522827148438 1.816766738891602 L 4.967541694641113 9.470388412475586 L 7.218965530395508 7.218964099884033 L 9.514205932617188 4.923730373382568 L 1.826522827148438 1.816766738891602 M -4.76837158203125e-06 4.76837158203125e-06 L 11.28951549530029 4.562644481658936 L 7.926075458526611 7.926074028015137 L 4.612645149230957 11.23950386047363 L -4.76837158203125e-06 4.76837158203125e-06 Z\"/></g><g transform=\"translate(317.185 -238.466)\"><line class=\"i\" y2=\"15\"/></g></g><line class=\"i\" transform=\"translate(361.5 614.5)\" x2=\"15\"/><line class=\"i\" transform=\"translate(361.5 685.5)\" x2=\"15\"/><line class=\"i\" transform=\"translate(376.5 542.5)\" y2=\"143\"/><line class=\"i\" transform=\"translate(481.5 632.5)\" x2=\"47\"/><line class=\"i\" transform=\"translate(528.5 632.5)\" y2=\"42\"/><g transform=\"translate(361.733 887.371)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(317.185 -238.479)\"><line class=\"i\" transform=\"translate(0)\" y2=\"26\"/></g></g><rect class=\"q\" height=\"40\" transform=\"translate(714 578)\" width=\"40\"/><text class=\"n\" transform=\"translate(734 607)\"><tspan x=\"-9.031\" y=\"0\">W</tspan><tspan class=\"c\" y=\"0\">o</tspan></text><text class=\"p\" transform=\"translate(632 704)\"><tspan x=\"-31.608\" y=\"0\">q.(h*w)</tspan></text><text class=\"p\" transform=\"translate(733 571)\"><tspan x=\"-31.608\" y=\"0\">(h*w).v</tspan></text><g class=\"s\" transform=\"translate(555 593.992)\"><rect class=\"y\" height=\"51.199\" width=\"154.712\"/><rect class=\"aa\" height=\"50.199\" width=\"153.712\" x=\"0.5\" y=\"0.5\"/></g><g class=\"t\" transform=\"translate(561.601 591.629)\"><rect class=\"y\" height=\"55.451\" width=\"140.41\"/><rect class=\"aa\" height=\"54.451\" width=\"139.41\" x=\"0.5\" y=\"0.5\"/></g><rect class=\"u\" height=\"40\" transform=\"translate(560 600)\" width=\"49\"/><text class=\"n\" transform=\"translate(586 628)\"><tspan x=\"-9.031\" y=\"0\">U</tspan><tspan class=\"c\" y=\"0\">1</tspan></text><rect class=\"u\" height=\"40\" transform=\"translate(655 600)\" width=\"49\"/><text class=\"n\" transform=\"translate(680 627)\"><tspan x=\"-9.031\" y=\"0\">U</tspan><tspan class=\"c\" y=\"0\">h</tspan></text><text class=\"n\" transform=\"translate(632 619)\"><tspan x=\"-18.062\" y=\"0\">...</tspan></text><line class=\"i\" transform=\"translate(528.5 674.5)\" x2=\"150\"/><text class=\"p\" transform=\"translate(586 656)\"><tspan x=\"-13.546\" y=\"0\">q.w</tspan></text><g transform=\"translate(543.125 280.393) rotate(90)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(317.185 -238.479)\"><line class=\"i\" transform=\"translate(0)\" y2=\"26\"/></g></g><rect class=\"u\" height=\"40\" transform=\"translate(900 594)\" width=\"40\"/><text class=\"n\" transform=\"translate(920 621)\"><tspan x=\"-9.031\" y=\"0\">U</tspan><tspan class=\"c\" y=\"0\">a</tspan></text><text class=\"o\" transform=\"translate(923 652)\"><tspan x=\"-31.608\" y=\"0\">q.v=n.d</tspan></text><line class=\"v\" transform=\"translate(524.5 557.5)\" y2=\"20\"/><g class=\"w\" transform=\"translate(897.103 344.785) rotate(180)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(317.185 -238.479)\"><line class=\"i\" transform=\"translate(0)\" y2=\"26\"/></g></g><text class=\"x\" transform=\"matrix(0.469, -0.883, 0.883, 0.469, 491.181, 609.286)\"><tspan x=\"-13.546\" y=\"0\">...</tspan></text><line class=\"v\" transform=\"translate(524.5 557.5)\" x2=\"55\"/><line class=\"v\" transform=\"translate(503.5 577.5)\" x2=\"21\"/><g transform=\"translate(606 919)\"><rect class=\"f\" height=\"52\" transform=\"translate(-331 -399)\" width=\"86\"/><text class=\"g\" transform=\"translate(-287 -366)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text></g><g transform=\"translate(1115 987)\"><rect class=\"f\" height=\"52\" transform=\"translate(-331 -399)\" width=\"86\"/><text class=\"g\" transform=\"translate(-287 -366)\"><tspan x=\"-36.123\" y=\"0\">MatMul</tspan></text></g><g transform=\"translate(272.605 699.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"65\"/></g><g class=\"l\" transform=\"translate(781.232 630.56) rotate(135)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(780.605 630.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"65\"/></g><g transform=\"translate(780.605 630.578) rotate(90)\"><line class=\"i\" transform=\"translate(0 0)\" y2=\"65\"/></g><g transform=\"translate(660.125 296.393) rotate(90)\"><g class=\"l\" transform=\"translate(317.167 -239.107) rotate(45)\"><path class=\"y\" d=\"M 4.624250411987305 10.18009090423584 L 0.89665687084198 0.8917896747589111 L 10.22691440582275 4.577427387237549 L 7.402166843414307 7.40216588973999 L 4.624250411987305 10.18009090423584 Z\"/><path class=\"z\" d=\"M 1.793312072753906 1.783587455749512 L 4.806203842163086 9.291015625 L 7.048606872558594 7.048605918884277 L 9.334651947021484 4.762567520141602 L 1.793312072753906 1.783587455749512 M -2.86102294921875e-06 -3.814697265625e-06 L 11.11915683746338 4.392285823822021 L 7.755717277526855 7.755715847015381 L 4.442286968231201 11.0691556930542 L -2.86102294921875e-06 -3.814697265625e-06 Z\"/></g><g transform=\"translate(317.185 -238.479)\"><line class=\"i\" transform=\"translate(0)\" y2=\"26\"/></g></g></g></svg>"
      ],
      "text/plain": [
       "<IPython.core.display.SVG object>"
      ]
     },
     "execution_count": 22,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "SVG(filename=\"images/003/multi-head.svg\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Input Representation\n",
    "\n",
    "This work used a Byte Pair Encoding scheme. This is a subword tokenization of your vocabulary. This is much more valuable than a UNK symbol. To build this representation, an iterative algorithm can be used to link together the most common segments, starting with character pairs."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Position-wise Feed-Forward Networks\n",
    "\n",
    "This two linear transforms with a nonlinear (RELU) operation.\n",
    "\n",
    "\\begin{equation}\n",
    "    \\texttt{FFN}(x) = \\max(0, xW_1 + b_1)W_2 + b_2\n",
    "\\end{equation}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "metadata": {},
   "outputs": [],
   "source": [
    "class PositionwiseFeedForward(nn.Module):\n",
    "    \"Implements FFN equation.\"\n",
    "    def __init__(self, d_model=512, d_ff=2048, dropout=0.1):\n",
    "        super(PositionwiseFeedForward, self).__init__()\n",
    "        self.w_1 = nn.Linear(d_model, d_ff)\n",
    "        self.w_2 = nn.Linear(d_ff, d_model)\n",
    "        self.dropout = nn.Dropout(dropout)\n",
    "\n",
    "    def forward(self, x):\n",
    "        return self.w_2(self.dropout(F.relu(self.w_1(x))))"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Each instance of the transformer will output a probability for the next symbol. As you can see, the encoder and decoder stacks are repeated N times each. In the paper the default was N = 6. The input and ouput of each stack is the of the same dimensionality. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "image/svg+xml": [
       "<svg viewBox=\"0 0 772 1030\" xmlns=\"http://www.w3.org/2000/svg\"><defs><style>.a{fill:#f7f7f7;}.a,.c,.g{stroke:#707070;}.b,.o{fill:#707070;}.c,.n{fill:none;}.d{fill:#9db4ff;}.e,.h{fill:#020000;font-size:20px;}.e{font-family:Menlo-Regular, Menlo;}.f{font-size:10px;}.g{fill:#fff;}.h{font-family:Hack-Regular, Hack;}.i{fill:#10ebfd;}.j{fill:#9dffa8;}.k{fill:#ff9d9d;}.l{fill:#fb9dff;}.m,.o{stroke:none;}</style></defs><g transform=\"translate(457 297)\"><g class=\"a\" transform=\"translate(-13 -19)\"><rect class=\"m\" height=\"549\" width=\"275\"/><rect class=\"n\" height=\"548\" width=\"274\" x=\"0.5\" y=\"0.5\"/></g><g class=\"b\" transform=\"translate(126.5 -42) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><path class=\"c\" d=\"M0,0V121.569\" transform=\"translate(126.518 -36.373)\"/><g class=\"a\" transform=\"translate(-389 186)\"><rect class=\"m\" height=\"341\" width=\"275\"/><rect class=\"n\" height=\"340\" width=\"274\" x=\"0.5\" y=\"0.5\"/></g><line class=\"c\" transform=\"translate(-246.5 161.5)\" y2=\"110\"/><line class=\"c\" transform=\"translate(-246.5 345.627)\" x1=\"0.018\" y2=\"78.873\"/><rect class=\"d\" height=\"40\" transform=\"translate(-350 611)\" width=\"208\"/><text class=\"e\" transform=\"translate(-246 638)\"><tspan x=\"-90.308\" y=\"0\">Input Embedding</tspan></text><rect class=\"d\" height=\"40\" transform=\"translate(22 611)\" width=\"208\"/><text class=\"e\" transform=\"translate(126 638)\"><tspan x=\"-96.328\" y=\"0\">Output Embedding</tspan></text><g class=\"b\" transform=\"translate(-246.5 661.893) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(-246.5 662.521)\"><line class=\"c\" y2=\"30\"/></g><g class=\"b\" transform=\"translate(-246.5 661.893) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(-246.5 662.521)\"><line class=\"c\" y2=\"30\"/></g><g class=\"b\" transform=\"translate(125.5 658.893) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(125.5 659.521)\"><line class=\"c\" y2=\"30\"/></g><g class=\"b\" transform=\"translate(125.5 658.893) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><g transform=\"translate(125.5 659.521)\"><line class=\"c\" y2=\"30\"/></g><text class=\"e\" transform=\"translate(-246 721)\"><tspan x=\"-36.123\" y=\"0\">Inputs</tspan></text><text class=\"e\" transform=\"translate(126 716)\"><tspan x=\"-42.144\" y=\"0\">Outputs</tspan><tspan class=\"f\"><tspan x=\"-45.154\" y=\"14\">(shifted right)</tspan></tspan></text><g transform=\"translate(-17 536)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><g class=\"g\" transform=\"translate(-256 559)\"><circle class=\"m\" cx=\"10\" cy=\"10\" r=\"10\"/><circle class=\"n\" cx=\"10\" cy=\"10\" r=\"9.5\"/></g><text class=\"h\" transform=\"translate(-246 576)\"><tspan x=\"-6.021\" y=\"0\">+</tspan></text><g class=\"g\" transform=\"translate(-325 549)\"><circle class=\"m\" cx=\"20\" cy=\"20\" r=\"20\"/><circle class=\"n\" cx=\"20\" cy=\"20\" r=\"19.5\"/></g><line class=\"c\" transform=\"translate(-320.5 557.5)\" x2=\"31\" y2=\"24\"/><g transform=\"translate(-212.928 797.035) rotate(90)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><text class=\"e\" transform=\"translate(-396 565)\"><tspan x=\"-60.205\" y=\"0\">Positional</tspan><tspan x=\"-48.164\" y=\"24\">Encoding</tspan></text><g transform=\"translate(-22 302)\"><path class=\"i\" d=\"M0,0H145V60.864H0Z\" transform=\"translate(-297 122)\"/><text class=\"e\" transform=\"translate(-225 147)\"><tspan x=\"-60.205\" y=\"0\">Multi-Head</tspan><tspan x=\"-54.185\" y=\"24\">Attention</tspan></text></g><g transform=\"translate(-332 363)\"><rect class=\"j\" height=\"52\" transform=\"translate(13)\" width=\"145\"/><text class=\"h\" transform=\"translate(87 33)\"><tspan x=\"-60.205\" y=\"0\">Add &amp; Norm</tspan></text></g><g transform=\"translate(-289 267)\"><rect class=\"k\" height=\"64\" transform=\"translate(-29 -3)\" width=\"145\"/><text class=\"h\" transform=\"translate(44 24)\"><tspan x=\"-30.103\" y=\"0\">Feed </tspan><tspan x=\"-42.144\" y=\"24\">Forward</tspan></text></g><g transform=\"translate(-332 204)\"><rect class=\"j\" height=\"52\" transform=\"translate(13)\" width=\"145\"/><text class=\"h\" transform=\"translate(87 33)\"><tspan x=\"-60.205\" y=\"0\">Add &amp; Norm</tspan></text></g><g class=\"b\" transform=\"translate(-295.5 488) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-295.482 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-295.482 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-296 505.5)\" x2=\"100.5\"/><g class=\"b\" transform=\"translate(-246.5 488) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-246.482 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-246.482 489.627)\" y2=\"16\"/><g class=\"b\" transform=\"translate(-195.5 488) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-195.482 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-195.482 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-246.5 500.627)\" x1=\"0.018\" y2=\"45.873\"/><g transform=\"translate(-276.928 618.035) rotate(90)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><line class=\"c\" transform=\"translate(-342.5 388)\" y2=\"125.5\"/><line class=\"c\" transform=\"translate(-343 513.5)\" x2=\"96.5\"/><line class=\"c\" transform=\"translate(-246.482 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-342.5 388)\" y2=\"125.5\"/><line class=\"c\" transform=\"translate(-343 513.5)\" x2=\"96.5\"/><g class=\"b\" transform=\"translate(-246.5 333) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-246.482 334.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-246.482 334.627)\" y2=\"16\"/><g transform=\"translate(-276.928 463.035) rotate(90)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><line class=\"c\" transform=\"translate(-343 352.5)\" x2=\"96.5\"/><line class=\"c\" transform=\"translate(-246.482 334.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-342.5 233)\" y2=\"119.5\"/><text class=\"e\" transform=\"translate(-430 368)\"><tspan x=\"-18.062\" y=\"0\">N x</tspan></text><line class=\"c\" transform=\"translate(125.5 316.627)\" x1=\"0.018\" y2=\"78.873\"/><g transform=\"translate(355 536)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><g class=\"g\" transform=\"translate(116 559)\"><circle class=\"m\" cx=\"10\" cy=\"10\" r=\"10\"/><circle class=\"n\" cx=\"10\" cy=\"10\" r=\"9.5\"/></g><text class=\"h\" transform=\"translate(126 576)\"><tspan x=\"-6.021\" y=\"0\">+</tspan></text><g class=\"g\" transform=\"translate(47 549)\"><circle class=\"m\" cx=\"20\" cy=\"20\" r=\"20\"/><circle class=\"n\" cx=\"20\" cy=\"20\" r=\"19.5\"/></g><line class=\"c\" transform=\"translate(51.5 557.5)\" x2=\"31\" y2=\"24\"/><g transform=\"translate(159.072 797.035) rotate(90)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><text class=\"e\" transform=\"translate(-24 565)\"><tspan x=\"-60.205\" y=\"0\">Positional</tspan><tspan x=\"-48.164\" y=\"24\">Encoding</tspan></text><path class=\"i\" d=\"M0,0H145V88.363H0Z\" transform=\"translate(53 396.501)\"/><g transform=\"translate(350 302)\"><text class=\"e\" transform=\"translate(-225 122)\"><tspan x=\"-36.123\" y=\"0\">Masked</tspan><tspan x=\"-60.205\" y=\"24\">Multi-Head</tspan><tspan x=\"-54.185\" y=\"48\">Attention</tspan></text></g><g transform=\"translate(40 337)\"><rect class=\"j\" height=\"52\" transform=\"translate(13)\" width=\"145\"/><text class=\"h\" transform=\"translate(87 33)\"><tspan x=\"-60.205\" y=\"0\">Add &amp; Norm</tspan></text></g><g transform=\"translate(83 65)\"><rect class=\"k\" height=\"64\" transform=\"translate(-29 -3)\" width=\"145\"/><text class=\"h\" transform=\"translate(44 24)\"><tspan x=\"-30.103\" y=\"0\">Feed </tspan><tspan x=\"-42.144\" y=\"24\">Forward</tspan></text></g><g transform=\"translate(41)\"><rect class=\"j\" height=\"52\" transform=\"translate(13)\" width=\"145\"/><text class=\"h\" transform=\"translate(87 33)\"><tspan x=\"-60.205\" y=\"0\">Add &amp; Norm</tspan></text></g><g class=\"b\" transform=\"translate(76.5 488) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(76.518 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(76.518 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(76 505.5)\" x2=\"100.5\"/><g class=\"b\" transform=\"translate(125.5 488) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(125.518 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(125.518 489.627)\" y2=\"16\"/><g class=\"b\" transform=\"translate(176.5 488) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(176.518 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(176.518 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(125.5 500.627)\" x1=\"0.018\" y2=\"45.873\"/><g transform=\"translate(95.072 589.035) rotate(90)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><line class=\"c\" transform=\"translate(29.5 388)\" y2=\"125.5\"/><line class=\"c\" transform=\"translate(29 513.5)\" x2=\"96.5\"/><line class=\"c\" transform=\"translate(125.518 489.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(29.5 359.5)\" y2=\"154\"/><line class=\"c\" transform=\"translate(29 513.5)\" x2=\"96.5\"/><g class=\"b\" transform=\"translate(125.5 131) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(125.518 132.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(125.518 132.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(125 316.5)\" x2=\"96.5\"/><line class=\"c\" transform=\"translate(125.518 132.627)\" x2=\"0.982\" y2=\"97.873\"/><text class=\"e\" transform=\"translate(296 275)\"><tspan x=\"-18.062\" y=\"0\">N x</tspan></text><g transform=\"translate(350 98)\"><path class=\"i\" d=\"M0,0H145V60.864H0Z\" transform=\"translate(-297 122)\"/><text class=\"e\" transform=\"translate(-225 147)\"><tspan x=\"-60.205\" y=\"0\">Multi-Head</tspan><tspan x=\"-54.185\" y=\"24\">Attention</tspan></text></g><line class=\"c\" transform=\"translate(-247 161.5)\" x2=\"187.5\"/><line class=\"c\" transform=\"translate(-59.5 162)\" y2=\"144.5\"/><line class=\"c\" transform=\"translate(-59 306.5)\" x2=\"184\"/><g class=\"b\" transform=\"translate(75.5 289) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(75.518 290.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(75.518 290.627)\" y2=\"16\"/><g class=\"b\" transform=\"translate(124.5 289) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(124.518 290.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(124.518 290.627)\" y2=\"16\"/><g class=\"b\" transform=\"translate(175.5 289) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(175.518 290.627)\" y2=\"16\"/><line class=\"c\" transform=\"translate(175.5 290.627)\" x1=\"0.018\" y2=\"25.873\"/><line class=\"c\" transform=\"translate(124.518 290.627)\" y2=\"16\"/><g transform=\"translate(40 160)\"><rect class=\"j\" height=\"52\" transform=\"translate(13)\" width=\"145\"/><text class=\"h\" transform=\"translate(87 33)\"><tspan x=\"-60.205\" y=\"0\">Add &amp; Norm</tspan></text></g><line class=\"c\" transform=\"translate(221.5 186.5)\" y2=\"130\"/><g transform=\"translate(156.965 -42.928) rotate(-90)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><g transform=\"translate(95.072 263.035) rotate(90)\"><g class=\"b\" transform=\"translate(-229.5 48) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-229.482 48.627)\" y2=\"16.479\"/></g><line class=\"c\" transform=\"translate(29 152.5)\" x2=\"96.5\"/><line class=\"c\" transform=\"translate(29.5 33)\" y2=\"119.5\"/><rect class=\"l\" height=\"52\" transform=\"translate(53 -105)\" width=\"145\"/><text class=\"h\" transform=\"translate(127 -72)\"><tspan x=\"-36.123\" y=\"0\">Linear</tspan></text><g class=\"b\" transform=\"translate(126.5 -137) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(126.518 -135.373)\" y2=\"16\"/><line class=\"c\" transform=\"translate(126.5 -135.373)\" x1=\"0.018\" y2=\"25.873\"/><rect class=\"i\" height=\"52\" transform=\"translate(53 -196)\" width=\"145\"/><text class=\"h\" transform=\"translate(127 -163)\"><tspan x=\"-42.144\" y=\"0\">Softmax</tspan></text><g class=\"b\" transform=\"translate(126.5 -238) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(126.518 -236.373)\" y2=\"16\"/><line class=\"c\" transform=\"translate(126.5 -236.373)\" x1=\"0.018\" y2=\"25.873\"/><text class=\"e\" transform=\"translate(127 -278)\"><tspan x=\"-36.123\" y=\"0\">Output</tspan><tspan x=\"-78.267\" y=\"24\">Probabilities</tspan></text><g transform=\"translate(-93 -318)\"><path class=\"i\" d=\"M0,0H145V60.864H0Z\" transform=\"translate(-297 122)\"/><text class=\"e\" transform=\"translate(-225 147)\"><tspan x=\"-60.205\" y=\"0\">Multi-Head</tspan><tspan x=\"-54.185\" y=\"24\">Attention</tspan></text></g><g class=\"b\" transform=\"translate(-366.5 -127) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-366.482 -125.373)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-366.5 -125.373)\" x1=\"0.018\" y2=\"28.873\"/><g class=\"b\" transform=\"translate(-317.5 -127) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-317.482 -125.373)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-317.482 -125.373)\" y2=\"16\"/><g class=\"b\" transform=\"translate(-266.5 -127) rotate(45)\"><path class=\"m\" d=\"M 4.48930025100708 10.31504917144775 L 0.8653011322021484 0.8604671359062195 L 10.36387062072754 4.440470218658447 L 7.402174472808838 7.402174949645996 L 4.48930025100708 10.31504917144775 Z\"/><path class=\"o\" d=\"M 1.730582237243652 1.720914840698242 L 4.680450439453125 9.416769027709961 L 7.048614501953125 7.048604965209961 L 9.462241172790527 4.6349778175354 L 1.730582237243652 1.720914840698242 M 4.76837158203125e-06 -4.76837158203125e-06 L 11.26548385620117 4.245954990386963 L 7.755724430084229 7.755715370178223 L 4.298134326934814 11.21330547332764 L 4.76837158203125e-06 -4.76837158203125e-06 Z\"/></g><line class=\"c\" transform=\"translate(-266.482 -125.373)\" y2=\"16\"/><line class=\"c\" transform=\"translate(-266.5 -125.373)\" x1=\"0.018\" y2=\"28.873\"/><line class=\"c\" transform=\"translate(-317.5 -119.373)\" x1=\"0.018\" y2=\"22.873\"/><rect class=\"d\" height=\"40\" transform=\"translate(-387 -88)\" width=\"40\"/><text class=\"e\" transform=\"translate(-367 -61)\"><tspan x=\"-6.021\" y=\"0\">K</tspan></text><rect class=\"d\" height=\"40\" transform=\"translate(-337 -88)\" width=\"40\"/><text class=\"e\" transform=\"translate(-317 -61)\"><tspan x=\"-6.021\" y=\"0\">V</tspan></text><rect class=\"d\" height=\"40\" transform=\"translate(-285 -88)\" width=\"40\"/><text class=\"e\" transform=\"translate(-265 -61)\"><tspan x=\"-6.021\" y=\"0\">Q</tspan></text></g></svg>"
      ],
      "text/plain": [
       "<IPython.core.display.SVG object>"
      ]
     },
     "execution_count": 25,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "SVG(filename=\"images/003/architecture.svg\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "When decoding an output sequence, the network is run repeatedly. A greedy approach looks something like this:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "metadata": {},
   "outputs": [],
   "source": [
    "def greedy_decode(model, src, src_mask, max_len, start_symbol):\n",
    "    memory = model.encode(src, src_mask)\n",
    "    ys = torch.ones(1, 1).fill_(start_symbol).type_as(src.data)\n",
    "    for i in range(max_len-1):\n",
    "        out = model.decode(\n",
    "            memory, \n",
    "            src_mask,\n",
    "            Variable(ys),\n",
    "            Variable(subsequent_mask(ys.size(1)).type_as(src.data)))\n",
    "        prob = model.generator(out[:, -1])\n",
    "        _, next_word = torch.max(prob, dim = 1)\n",
    "        next_word = next_word.data[0]\n",
    "        ys = torch.cat([ys, \n",
    "                        torch.ones(1, 1).type_as(src.data).fill_(next_word)], dim=1)\n",
    "    return ys"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "A beam search approach instead would select the best path by maintaining *k* beams - i.e. the best-so-far k paths."
   ]
  }
 ],
 "metadata": {
  "celltoolbar": "Raw Cell Format",
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
